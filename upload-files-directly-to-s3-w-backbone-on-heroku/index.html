
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Upload files directly to S3 w/ Backbone on Heroku - Micah Roberson</title>
  <meta name="author" content="Micah Roberson">

  
  <meta name="description" content="How to upload files directly to an S3 bucket via javascript/coffeescript from a Rails app hosted on Heroku.">
  <meta name="keywords" content="s3, backbone, upload, files, input type file, rails, CORS, Heroku">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta itemprop="image" content="http://micahroberson.com/images/micah-headshot-color-square.png">

  
  <link rel="canonical" href="http://micahroberson.com/upload-files-directly-to-s3-w-backbone-on-heroku">
  <link href="/favicon.ico" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Micah Roberson" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34306816-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <meta property="og:url" content="http://micahroberson.com/upload-files-directly-to-s3-w-backbone-on-heroku/">
<meta property="og:type" content="website" />

<meta property="og:title" content="Upload files directly to S3 w/ Backbone on Heroku">
<meta property="og:description" content="How to upload files directly to an S3 bucket via javascript/coffeescript from a Rails app hosted on Heroku.">
 

</head>

<body id="skrollr-body"   class="no-sidebar"  >
  
  <span itemscope itemtype="http://schema.org/Article">
  
  <header role="banner"><div class='navbar-wrapper shadow'>
  <a href="/">
    <div class="logo"></div>
    <div class="profile"></div>
    <span class="header-name" itemprop="author" itemscope itemtype="http://schema.org/Person">
      <span itemprop="name">Micah Roberson</span>
    </span>
    <span class="header-desc">Programmer & Entrepreneur in San Francisco</span>
  </a>
  <nav>
    <ul>
      <li class='hide-tablet'><a href='https://doozie.io?utm_source=micahroberson.com&utm_medium=navbar' target='_blank'><img src="/images/doozie_logo.png" style="max-width: 90px; margin-right: 40px; vertical-align: middle;"></a></li>
      <li class='hide-tablet'><a href='https://raddevelopment.io?utm_source=micahroberson.com&utm_medium=navbar' target='_blank'><img src="/images/RAD-logo-white-background.png" style="max-width: 70px;margin-right: 80px;vertical-align: middle;"></a></li>
      <li><a class='social-media-link' href='https://twitter.com/micahroberson' target='_blank'><i class='icon-twitter'></i></a></li>
      <li><a class='social-media-link' href='https://www.github.com/micahroberson' target='_blank'><i class='icon-github'></i></a></li>
      <li><a class='social-media-link' href='/atom.xml' target='_blank'><i class='icon-feed' style='margin-left:3px;'></i></a></li>
    </ul>
  </nav>
  <span style='display:none;'>By <a href='https://plus.google.com/106721416583632264667' rel='author'>Micah Roberson</a></span>
  <!-- <div class='social-links'>
    <a class='social-media-link' href='https://twitter.com/micahroberson' target='_blank'><i class='icon-twitter'></i></a>
    <a class='social-media-link' href='https://www.github.com/micahroberson' target='_blank'><i class='icon-github'></i></a>
    <a class='social-media-link' href='/atom.xml' target='_blank'><i class='icon-feed'></i></a>
    <a class='social-media-link' href='mailto:micah.roberson@gmail.com' target='_blank'><i class='icon-mail'></i></a>
  </div> -->
</div>
</header>
  <nav role="navigation">
  

</nav>
  <div id="main">
    
    <div id="content">
      <div>
<article class="hentry" role="article"  itemscope itemtype="http://schema.org/BlogPosting">
  
  <header>
    
      <h2 class="entry-title">
        Upload Files Directly to S3 W/ Backbone on Heroku
        <!-- 
          <span style="float:right;margin-top:2px;">
            <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://micahroberson.com/upload-files-directly-to-s3-w-backbone-on-heroku/" data-via="micahroberson" data-counturl="http://micahroberson.com/upload-files-directly-to-s3-w-backbone-on-heroku/" >Tweet</a>
          </span>
         -->
      </h2>
      
        <p class="meta">
          








  


<time datetime="2013-10-04T09:40:00-07:00" pubdate data-updated="true">Oct 04</time>
          
        </p>
      
    
  </header>


<div class="entry-content" itemprop="articleBody"><p><a href="http://aws.amazon.com/s3/">S3</a> has been the defacto standard for some time now when it comes to cloud storage, specifically for handling user uploads within an app. PaaS providers often have limitations on storage and/or file uploads - most notably Heroku, which doesn’t allow any file writes outside of the /tmp directory. Fortunately this is an easy enough problem to solve, with help from <a href="https://github.com/thoughtbot/paperclip">Paperclip</a> and <a href="https://github.com/carrierwaveuploader/carrierwave">CarrierWave</a>. Although utilizing one of these options may be easy and not all that different from how you would handle user uploads in a classic Rails app where you CAN write to the filesystem, they aren’t all that efficient on Heroku. A simple file upload becomes a data-intesive, long-drawn-out request in order to get the file from the browser(client) to the server(Heroku) and then to S3. Ideally these gems would process the file(s) in the background, and we could say the time to do so is negligible as a result. But when we decide we want to show progress to the user and also know when the upload is complete, things get a lot more complicated!</p>

<!--more-->

<p>This solution was originally built by Rok Krulec at <a href="http://dubjoy.com">Dubjoy</a>, and can be found here: <a href="http://codeartists.com/post/36892733572/how-to-directly-upload-files-to-amazon-s3-from-your">http://codeartists.com/post/36892733572/how-to-directly-upload-files-to-amazon-s3-from-your</a>, but I’ve forked the code and made some tweaks to handle multiple files, progress, and cancellations.</p>

<p>In order to implement the entirety of this setup, you’ll need a CORS enabled bucket. Follow <a href="http://codeartists.com/post/36892733572/how-to-directly-upload-files-to-amazon-s3-from-your">Step 1</a> for instructions. You’ll also need to setup server-side request signing, which Rok Krulec shows how to do in <a href="http://codeartists.com/post/36892733572/how-to-directly-upload-files-to-amazon-s3-from-your">Step 3</a>. </p>

<p>For the client-side implementation, which is Step 2 from the blog post linked above, we’ll do things a little differently.</p>

<p>You can find my forked repo with the necessary S3Upload lib here: <a href="https://github.com/micahroberson/s3upload-coffee-javascript">https://github.com/micahroberson/s3upload-coffee-javascript</a> </p>

<p>To a Backbone view I’ve added the following:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line">  <span class="c1"># Listener to detect when the user has selected a file.</span>
</span><span class="line">  <span class="c1"># We could also opt for a click event on an &#39;Upload Files&#39; button instead</span>
</span><span class="line">  <span class="nv">events:</span>
</span><span class="line">    <span class="s">&#39;change input#Files&#39;</span><span class="o">:</span> <span class="s">&#39;onChangeFiles&#39;</span>
</span><span class="line">
</span><span class="line">  <span class="p">...</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># Listen for newly added models and render a view for each</span>
</span><span class="line">  <span class="nv">initialize: </span><span class="p">()</span> <span class="nf">-&gt;</span>
</span><span class="line">    <span class="nx">@listenTo</span> <span class="nx">@attachmentsCollection</span><span class="p">,</span> <span class="s">&#39;add&#39;</span><span class="p">,</span> <span class="nx">@onAddAttachment</span>
</span><span class="line">  <span class="p">...</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># Instantiate and render new views for models added to the collection</span>
</span><span class="line">  <span class="c1"># This is the view that will be listening to the &#39;upload:progress&#39; event, and can also allow the user to cancel the upload</span>
</span><span class="line">  <span class="nv">onAddAttachment: </span><span class="nf">(model, response) -&gt;</span>
</span><span class="line">    <span class="nv">attachmentView = </span><span class="k">new</span> <span class="nx">Doozie</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Attachments</span><span class="p">.</span><span class="nx">Show</span><span class="p">(</span><span class="nv">model: </span><span class="nx">model</span><span class="p">)</span>
</span><span class="line">    <span class="nx">@$</span><span class="p">(</span><span class="s">&#39;.card-attachments&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">attachmentView</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span><span class="p">)</span>
</span><span class="line">    <span class="nx">@attachmentViews</span><span class="p">[</span><span class="nx">model</span><span class="p">.</span><span class="nx">cid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">attachmentView</span>
</span><span class="line">
</span><span class="line">  <span class="p">...</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># Callback bound above which triggers the actual upload via the S3Upload lib</span>
</span><span class="line">  <span class="nv">onChangeFiles: </span><span class="nf">(e) -&gt;</span>
</span><span class="line">    <span class="k">return</span> <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;&#39;</span>
</span><span class="line">
</span><span class="line">    <span class="nx">@uploadToS3</span>
</span><span class="line">      <span class="nv">files_dropped: </span><span class="kc">false</span><span class="p">,</span>
</span><span class="line">      <span class="nv">file_dom_selector: </span><span class="s">&#39;#Files&#39;</span>
</span><span class="line">
</span><span class="line">  <span class="p">...</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># Instantiation of a new S3Upload with custom callbacks</span>
</span><span class="line">  <span class="nv">uploadToS3: </span><span class="nf">(options) -&gt;</span>
</span><span class="line">    <span class="c1"># We create an object to store the newly created models for reference in progress and abort callbacks</span>
</span><span class="line">    <span class="nv">newAttachments = </span><span class="p">{}</span>
</span><span class="line">    <span class="nv">s3upload = </span><span class="k">new</span> <span class="nx">S3Upload</span>
</span><span class="line">      <span class="c1"># files_dropped and file_list are only necessary for handling drag and drop uploads, which we&#39;ll address later</span>
</span><span class="line">      <span class="nv">files_dropped: </span><span class="nx">options</span><span class="p">.</span><span class="nx">files_dropped</span><span class="p">,</span>
</span><span class="line">      <span class="nv">file_list: </span><span class="nx">options</span><span class="p">.</span><span class="nx">file_list</span><span class="p">,</span>
</span><span class="line">      <span class="nv">file_dom_selector: </span><span class="nx">options</span><span class="p">.</span><span class="nx">file_dom_selector</span><span class="p">,</span>
</span><span class="line">      <span class="nv">s3_sign_put_url: </span><span class="s">&#39;/api/attachments/signput&#39;</span><span class="p">,</span>
</span><span class="line">
</span><span class="line">      <span class="nv">onProgress: </span><span class="nf">(xhr, file, percent, message) =&gt;</span>
</span><span class="line">        <span class="c1"># Create a new Attachment model for the file which has just started uploading, otherwise trigger an &#39;upload:progress&#39; event on the model which a view can listen for</span>
</span><span class="line">        <span class="k">if</span> <span class="nx">percent</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class="line">          <span class="nv">attachment = </span><span class="k">new</span> <span class="nx">Doozie</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Attachment</span>
</span><span class="line">            <span class="nv">name : </span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span><span class="line">            <span class="nv">s3_url: </span><span class="s">&#39;&#39;</span><span class="p">,</span>
</span><span class="line">            <span class="nv">card_id : </span><span class="nx">@model</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span><span class="line">            <span class="nv">project_id: </span><span class="nx">@model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;project_id&#39;</span><span class="p">),</span>
</span><span class="line">            <span class="nv">file_type : </span><span class="nx">file</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
</span><span class="line">            <span class="nv">size : </span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span><span class="line">          <span class="c1"># Key on file.size for uniqueness</span>
</span><span class="line">          <span class="nx">newAttachments</span><span class="p">[</span><span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="p">]</span> <span class="o">=</span> <span class="nx">attachment</span>
</span><span class="line">          <span class="c1"># Add the model to the Backbone collection, which will trigger an &#39;add&#39; event</span>
</span><span class="line">          <span class="nx">@attachmentsCollection</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">attachment</span><span class="p">)</span>
</span><span class="line">        <span class="k">else</span>
</span><span class="line">          <span class="nv">attachment = </span><span class="nx">newAttachments</span><span class="p">[</span><span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="p">]</span>
</span><span class="line">          <span class="k">if</span> <span class="nx">attachment</span>
</span><span class="line">            <span class="nx">attachment</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s">&#39;upload:progress&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nv">percent: </span><span class="nx">percent</span><span class="p">,</span> <span class="nv">message: </span><span class="nx">message</span><span class="p">,</span> <span class="nv">xhr: </span><span class="nx">xhr</span> <span class="p">})</span>
</span><span class="line">
</span><span class="line">      <span class="nv">onAbort: </span><span class="nf">(file, message) =&gt;</span>
</span><span class="line">        <span class="nv">attachment = </span><span class="nx">newAttachments</span><span class="p">[</span><span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="p">]</span>
</span><span class="line">        <span class="nx">attachment</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span>
</span><span class="line">        <span class="k">delete</span> <span class="nx">newAttachments</span><span class="p">[</span><span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="p">]</span>
</span><span class="line">        <span class="c1"># Must replace old input type=file. for some reason, it doesn&#39;t clear the value</span>
</span><span class="line">        <span class="nx">@$</span><span class="p">(</span><span class="s">&#39;input#Files&#39;</span><span class="p">).</span><span class="nx">replaceWith</span><span class="p">(</span><span class="s">&quot;&lt;input id=&#39;files&#39; type=&#39;file&#39; name=&#39;files[]&#39; multiple /&gt;&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">      <span class="nv">onFinishS3Put: </span><span class="nf">(public_url, file) =&gt;</span>
</span><span class="line">        <span class="c1"># Grab the attachment model and update it with the final url</span>
</span><span class="line">        <span class="c1"># Also note that the model has not yet been saved, so the backend would be unaware of a cancelled upload</span>
</span><span class="line">        <span class="nv">attachment = </span><span class="nx">newAttachments</span><span class="p">[</span><span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="p">]</span>
</span><span class="line">        <span class="nx">attachment</span><span class="p">.</span><span class="nx">save</span><span class="p">({</span> <span class="nv">s3_url: </span><span class="nx">public_url</span> <span class="p">})</span>
</span><span class="line">
</span><span class="line">      <span class="nv">onError: </span><span class="nf">(file, status) =&gt;</span>
</span><span class="line">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&#39;Upload error: &#39;</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span>
</span><span class="line">        <span class="nv">attachment = </span><span class="nx">newAttachments</span><span class="p">[</span><span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="p">]</span>
</span><span class="line">        <span class="nx">attachment</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span>
</span><span class="line">        <span class="k">delete</span> <span class="nx">newAttachments</span><span class="p">[</span><span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The attachment view(s) instantiated above looks like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line">  <span class="p">...</span>
</span><span class="line">
</span><span class="line">  <span class="nv">events: </span>
</span><span class="line">    <span class="s">&#39;click .cancel&#39;</span> <span class="o">:</span> <span class="s">&#39;onCancelUpload&#39;</span>
</span><span class="line">
</span><span class="line">  <span class="nv">initialize: </span><span class="p">()</span> <span class="nf">-&gt;</span>
</span><span class="line">    <span class="nx">@listenTo</span><span class="p">(</span><span class="nx">@model</span><span class="p">,</span> <span class="s">&#39;upload:progress&#39;</span><span class="p">,</span> <span class="nx">@onUploadProgress</span><span class="p">)</span>
</span><span class="line">    <span class="nx">@listenTo</span><span class="p">(</span><span class="nx">@model</span><span class="p">,</span> <span class="s">&#39;destroy&#39;</span><span class="p">,</span> <span class="nx">@destroy</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">  <span class="nv">onUploadProgress: </span><span class="nf">(data) -&gt;</span>
</span><span class="line">    <span class="nx">@$</span><span class="p">(</span><span class="s">&#39;.progress .meter&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s">&#39;width&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">data</span><span class="p">.</span><span class="nx">percent</span><span class="si">}</span><span class="s">%&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">percent</span> <span class="o">==</span> <span class="mi">100</span>
</span><span class="line">      <span class="c1"># If the upload is complete, remove the progress bar and cancel button</span>
</span><span class="line">      <span class="nx">@$</span><span class="p">(</span><span class="s">&#39;.progress, .cancel&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>
</span><span class="line">      <span class="vi">@_xhr = </span><span class="kc">null</span>
</span><span class="line">    <span class="k">else</span> <span class="k">if</span> <span class="o">!</span><span class="nx">@_xhr</span>
</span><span class="line">      <span class="c1"># Else if @_xhr is not yet defined, save a reference to it</span>
</span><span class="line">      <span class="vi">@_xhr = </span><span class="nx">data</span><span class="p">.</span><span class="nx">xhr</span>
</span><span class="line">
</span><span class="line">  <span class="nv">onCancelUpload: </span><span class="nf">(e) -&gt;</span>
</span><span class="line">    <span class="c1"># Leverage the saved xhr reference to abort() the upload</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">@_xhr</span>
</span><span class="line">      <span class="nx">@_xhr</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>On the Rails side of things, we’re really only storing the S3 url and a few other details about the file that we may want to display. The most important piece here is the after_destroy callback to actually delete the S3 object when the model is destroyed. Note that this uses the ‘aws-sdk’ gem. </p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line">  <span class="k">class</span> <span class="nc">Attachment</span>
</span><span class="line">    <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
</span><span class="line">    <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Timestamps</span>
</span><span class="line">
</span><span class="line">    <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
</span><span class="line">    <span class="n">field</span> <span class="ss">:s3_url</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
</span><span class="line">    <span class="n">field</span> <span class="ss">:file_type</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
</span><span class="line">    <span class="n">field</span> <span class="ss">:size</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Float</span>
</span><span class="line">
</span><span class="line">    <span class="n">belongs_to</span> <span class="ss">:creator</span><span class="p">,</span> <span class="n">class_name</span><span class="p">:</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">inverse_of</span><span class="p">:</span> <span class="kp">nil</span>
</span><span class="line">    <span class="n">belongs_to</span> <span class="ss">:card</span><span class="p">,</span> <span class="n">inverse_of</span><span class="p">:</span> <span class="ss">:blobs</span><span class="p">,</span> <span class="ss">touch</span><span class="p">:</span> <span class="kp">true</span>
</span><span class="line">
</span><span class="line">    <span class="n">after_destroy</span> <span class="ss">:delete_from_s3</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">delete_from_s3</span>
</span><span class="line">      <span class="n">s3</span> <span class="o">=</span> <span class="ss">AWS</span><span class="p">:</span><span class="ss">:S3</span><span class="o">.</span><span class="n">new</span> <span class="n">access_key_id</span><span class="p">:</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;S3_ACCESS_KEY&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">secret_access_key</span><span class="p">:</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;S3_SECRET_KEY&#39;</span><span class="o">]</span>
</span><span class="line">      <span class="n">key</span> <span class="o">=</span> <span class="n">s3_url</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;https://s3.amazonaws.com/</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;S3_BUCKET_NAME&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span class="line">      <span class="n">s3</span><span class="o">.</span><span class="n">buckets</span><span class="o">[</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;S3_BUCKET_NAME&#39;</span><span class="o">]].</span><span class="n">objects</span><span class="o">[</span><span class="n">key</span><span class="o">].</span><span class="n">delete</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>And that’s all there is to it! We’ve built a simple and efficient solution that allows users to upload multiple files at the same time, see indiviual progress bars for each file and also cancel each file independently. To take this a little further we can allow users to drag files onto the view and trigger an upload, and also create a proxy route for downloading files, which hides the actual S3 url. </p>

<p>To upload files on ‘drop’, just add the following event listener and handler, and it will trigger the same sequence of events as with the file type input.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="coffeescript"><span class="line">  <span class="nv">events: </span>
</span><span class="line">    <span class="s">&#39;drop&#39;</span>  <span class="o">:</span>  <span class="s">&#39;onDrop&#39;</span>
</span><span class="line">
</span><span class="line">  <span class="nv">onDrop: </span><span class="nf">(e) -&gt;</span>
</span><span class="line">    <span class="k">return</span> <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">dataTransfer</span> <span class="o">==</span> <span class="kc">null</span>
</span><span class="line">
</span><span class="line">    <span class="nx">@uploadToS3</span><span class="p">({</span>
</span><span class="line">      <span class="nv">files_dropped: </span><span class="kc">true</span><span class="p">,</span>
</span><span class="line">      <span class="nv">file_list: </span><span class="nx">e</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">files</span>
</span><span class="line">    <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>For the download link, we just use a controller action mapped to /attachments/download/:id</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line">    <span class="k">def</span> <span class="nf">download</span>
</span><span class="line">      <span class="vi">@attachment</span> <span class="o">=</span> <span class="no">Attachment</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">company_id</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">company_id</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span> <span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class="line">      <span class="n">data</span> <span class="o">=</span> <span class="nb">open</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="vi">@attachment</span><span class="o">.</span><span class="n">s3_url</span><span class="p">)</span>
</span><span class="line">      <span class="n">send_data</span> <span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="ss">filename</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@attachment</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@attachment</span><span class="o">.</span><span class="n">file_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">disposition</span><span class="p">:</span> <span class="s1">&#39;inline&#39;</span><span class="p">,</span> <span class="ss">stream</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">:</span> <span class="s1">&#39;4096&#39;</span>
</span><span class="line">    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

</div>

  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Micah Roberson</span></span>

      








  


<time datetime="2013-10-04T09:40:00-07:00" pubdate data-updated="true">Oct 04</time>
      


    </p>
    <!-- 
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://micahroberson.com/upload-files-directly-to-s3-w-backbone-on-heroku/" data-via="micahroberson" data-counturl="http://micahroberson.com/upload-files-directly-to-s3-w-backbone-on-heroku/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

     -->
    <p class="meta">
      
        <a class="basic-alignment left" href="/saving-drag-and-drop-sort-position/" title="Previous Post: Saving Drag and Drop Sort Position">&laquo; Saving Drag and Drop Sort Position</a>
      
      
        <a class="basic-alignment right" href="/mobile-and-responsive-navigation-without-jpanelmenu/" title="next Post: Mobile and Responsive Navigation without jPanelMenu">Mobile and Responsive Navigation without jPanelMenu &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <div id="disqus_thread" aria-live="polite">

<script type="text/javascript">
      var disqus_shortname = 'micahroberson';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://micahroberson.com/upload-files-directly-to-s3-w-backbone-on-heroku/';
        var disqus_url = 'http://micahroberson.com/upload-files-directly-to-s3-w-backbone-on-heroku/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>

</div>
  </section>

</div>


    </div>
  </div>
  
  </span>
  
</body>
</html>
