
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Saving Drag and Drop Sort Position - Micah Roberson</title>
  <meta name="author" content="Micah Roberson">

  
  <meta name="description" content="Efficiently store and retrieve sort ordering/positioning in a drag and drop GUI built with jQuery UI, Backbone.js, Rails and MongoDB.">
  <meta name="keywords" content="drag and drop, sort position, sort index, efficient, store, save">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://micahroberson.com/saving-drag-and-drop-sort-position">
  <link href="/favicon.ico" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Micah Roberson" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34306816-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <meta property="og:url" content="http://micahroberson.com/saving-drag-and-drop-sort-position/">
<meta property="og:type" content="website" />

<meta property="og:title" content="Saving Drag and Drop Sort Position">
<meta property="og:description" content="Efficiently store and retrieve sort ordering/positioning in a drag and drop GUI built with jQuery UI, Backbone.js, Rails and MongoDB.">
 

</head>

<div style="
    position: fixed;
    width: 100%;
    height: 100%;
    left: 0;
    background: url(/images/desk.jpg) fixed center;
    -webkit-background-size: cover;
    -moz-background-size: cover;
    -o-background-size: cover;
    background-size: cover;
    z-index: -1;
"></div>
<div style="
    position: fixed;
    width: 100%;
    height: 100%;
    left: 0;
    background-color: rgba(255, 255, 255, 0.95);
    z-index: -1;
"></div>
<body id="skrollr-body"   class="no-sidebar"  >
  <header role="banner"><div class='navbar-wrapper' data-0="position:static;box-shadow:none;" data-top-top='position:fixed;top:0;left:0;box-shadow:0px 1px 1px rgba(0,0,0,0.2)'>
  <a href="/">
    <div class="logo" data-0="width:133px;height:133px;" data--200-top-top="width:50px;height:50px;" ><span></span></div>
  </a>
  <div class="intro">
    <h1>Micah Roberson</h1>
    <h2>Developer &amp; Entrepreneur</h2>
    <h4>San Francisco, California</h4>
    <span style='display:none'>By <a href='https://plus.google.com/106721416583632264667' rel='author'>Micah Roberson</a></span>
    <a class='social-media-link' href='https://twitter.com/micahroberson' target='_blank'><i class='icon-twitter'></i></a>
    <a class='social-media-link' href='https://www.github.com/micahroberson' target='_blank'><i class='icon-github'></i></a>
    <a class='social-media-link' href='/atom.xml' target='_blank'><i class='icon-feed'></i></a>
    <a class='social-media-link' href='mailto:micah.roberson@gmail.com' target='_blank'><i class='icon-mail'></i></a>
  </div>
</div>

</header>
  <nav role="navigation">
  

</nav>
  <footer class='fixed-footer'>
    <div class='social-links'>
    
<section>
	<form action="http://micahroberson.us7.list-manage.com/subscribe/post?u=604e31743665c33977d2efa00&amp;id=bf22667003" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" target="_blank">
    <span>Get Fresh Content</span>
		<input type="text" placeholder="Your Email Here" autocomplete="off" name="EMAIL" id="mce-EMAIL">
		<button type="submit" name="subscribe" id="mc-embedded-subscribe">Subscribe</button>
	</form>
</section>


    </div>
  </footer>
  <div id="main">
    <div id="content" class="fadein">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <p class="meta">
        








  


<time datetime="2013-09-25T10:35:00-07:00" pubdate data-updated="true">Sep 25</time>
        
      </p>
    
    
      <h4 class="entry-title">Saving Drag and Drop Sort Position</h4>
    
  </header>


<div class="entry-content"><p>We recently began work on an in-house solution for managing our projects at <a href="https://www.readyappsdev.com">ReadyApps</a>, and this solution requires that we have the ability to drag and drop &#8216;cards&#8217; in the same light as Trello or Blossom. Drag and drop interfaces are certainly nothing new and neither is rearranging the position of an element in a sorted array. However, I was unable to find much information on doing this in the most efficient way possible from a client-side javascript application.</p>

<p>I considered the following factors/constraints when determining the best implementation:</p>

<ul>
<li>Update new position(s) with a single ajax call</li>
<li>Allow for consecutive client-side moves without having to redraw the entire list after each move</li>
<li>Minimize backend work to save a move</li>
<li>Minimize backend work to retrieve cards from database and sort into proper order</li>
<li>Allow for real-time client-side updates from other users (ie. card position changes via websockets)</li>
<li>There should be no limit to the number of times a user can rearrage a set of cards</li>
<li>The solution should allow for a sufficiently high number of cards to be sorted and retrieved in decent amount of time</li>
</ul>


<p>The simplest solution would be to simply store a &#8216;position&#8217; on each card as an integer and sort by that column when retrieving from the database. However, this solution would require that dragging Card A from position 8 to position 1 would need to update all cards with position > 1. Although the query is trivial, these cards would need to be updated client-side as well in order to maintain a clean state. Clean state is important for allowing consecutive moves as well as updates from websockets.</p>

<p>Another solution is to store the sort order outside of the actual cards - ie. an array of card ids on the project model. I would prefer the order to be saved on the actual card (for API purposes, it makes more sense to be able to sort the cards without having the actual project model as well), this method also requires that we redraw every card on a change. I suppose we could diff the arrays client-side and determine which cards need to be moved, but I haven&#8217;t actually thought it through enough to be sure that would work efficiently.</p>

<p>The runner-up solution was to store the position on a card but as a double rather than an integer. Keeping this value a double means we can simply set the new position to half of the difference between the two cards. Moving a card from position 8 to position 1(assuming all cards have integer positions at this point), we would set the new position to (1 - 0) / 2 = 0.5. This would require a single save on the card that changed position, and we could still sort on the position column when retrieving the data. This also allows for handling position changes from other users via websockets. The one limitation is the number of rearrangements a user can make. Eventually we&#8217;re going to max out the decimal places on the double. We could re-sort all of the elements with a background job when the cards approach this limit, but that doesn&#8217;t seem like the right way to solve the problem.</p>

<p>The solution we ended up going with is to simulate a linked-list in order to maintain relevent position. Each card stores the id of the card it follows. This makes client-side updates extremely easy: if a card model changes, we simply find the id it follows and append it right after. As far as the client knows, only a single ajax call is required. Server-side, there&#8217;s actually two more operations that need to take place: updating the new follower of the card that moved, and updating the previous follower of the card that moved. When retrieving the data server-side, we can put all of the cards in order with a simple loop. Although the operation isn&#8217;t linear, the complexity is roughly O(n log n) - on par with mergesort. Some quick benchmarking showed the following results:</p>

<ul>
<li>0.001941s for 10 cards</li>
<li>0.205871s for 500 cards</li>
<li>0.812723s for 1000 cards</li>
</ul>


<p>Although it starts to climb quickly upwards of 1000 cards, its highly unlikely that a user would ever add that many cards and still expect good performance, so we&#8217;re content with the results.</p>

<p>Implementing the solution client-side with <a href="http://www.backbonejs.org">Backbone.js</a> and <a href="http://www.jqueryui.com">jQuery UI</a> is done with the following method to be called after a card is &#8216;dropped&#8217;:</p>

<pre><code>updatePositions: (e, ui) =&gt;
  $ui = ui.item
  id = $ui.data('model-id')
  $after = $ui.prev()

  afterCardId = if $after then $after.data('model-id') else null

  card = @cardsCollection.get(id)
  card.save(
    after_card_id: afterCardId
    )
</code></pre>

<p>Server-side we&#8217;ll add a method to be called after updating the after_card_id(ID of the preceding card, nil if first) of the card that moved:</p>

<pre><code>def update_after_card(stage_id_was, after_card_id_was)
  # Update card that previously came after
  Card.where(after_card_id: id).update_all(
    after_card_id: after_card_id_was
    )

  # Update card that now comes after
  Card.where(:id.ne =&gt; id).where(after_card_id: after_card_id).update_all(
    after_card_id: id
    )
end
</code></pre>

<p>Also server-side we can retrieve the data from a MongoDB backed Rails app as follows (this was a very quick implementation and there are definitely some improvements that could be made to improve the efficiency):</p>

<pre><code>has_many :cards
...
def ordered_cards
  cardsArray = []
  initialCardsArray = cards.to_a

  cardIdsArray = []
  indexHash = {}
  i = 0
  x = 0

  if initialCardsArray.size &lt;= 1
    return initialCardsArray
  end

  while initialCardsArray.size &gt; 0 do
    card = initialCardsArray[i]
    index = cardIdsArray.index(card.after_card_id)

    if card.after_card_id.nil?
      cardsArray.insert(0, card)
      cardIdsArray.insert(0, card.id.to_s)
      initialCardsArray.delete(card)
    elsif !index.nil?
      pos = index + 1
      cardsArray.insert(pos, card)
      cardIdsArray.insert(pos, card.id.to_s)
      initialCardsArray.delete(card)
    else
      i += 1
    end

    if i == initialCardsArray.size
      i = 0
    end

  end

  cardsArray
end
</code></pre>

<p>Any comments or additional solutions would be greatly appreciated! Comments section coming soon!</p>
</div>

  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Micah Roberson</span></span>

      








  


<time datetime="2013-09-25T10:35:00-07:00" pubdate data-updated="true">Sep 25</time>
      


    </p>
    
      <div class="sharing">
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/preventing-duplicate-content/" title="Previous Post: Preventing Duplicate Content | Rails SEO Tip">&laquo; Preventing Duplicate Content | Rails SEO Tip</a>
      
      
    </p>
  </footer>
</article>

</div>


    </div>
  </div>
</body>
</html>
