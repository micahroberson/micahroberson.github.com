
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Upload files directly to S3 w/ Backbone on Heroku - Micah Roberson</title>
  <meta name="author" content="Micah Roberson">

  
  <meta name="description" content="How to upload files directly to an S3 bucket via javascript/coffeescript from a Rails app hosted on Heroku.">
  <meta name="keywords" content="s3, backbone, upload, files, input type file, rails, CORS, Heroku">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://micahroberson.com/upload-files-directly-to-s3-w-backbone-on-heroku">
  <link href="/favicon.ico" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Micah Roberson" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34306816-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <meta property="og:url" content="http://micahroberson.com/upload-files-directly-to-s3-w-backbone-on-heroku/">
<meta property="og:type" content="website" />

<meta property="og:title" content="Upload files directly to S3 w/ Backbone on Heroku">
<meta property="og:description" content="How to upload files directly to an S3 bucket via javascript/coffeescript from a Rails app hosted on Heroku.">
 

</head>

<div style="
    position: fixed;
    width: 100%;
    height: 100%;
    left: 0;
    background: url(/images/desk.jpg) fixed center;
    -webkit-background-size: cover;
    -moz-background-size: cover;
    -o-background-size: cover;
    background-size: cover;
    z-index: -1;
"></div>
<div style="
    position: fixed;
    width: 100%;
    height: 100%;
    left: 0;
    background-color: rgba(255, 255, 255, 0.95);
    z-index: -1;
"></div>
<body id="skrollr-body"   class="no-sidebar"  >
  <header role="banner"><div class='navbar-wrapper' data-0="position:static;box-shadow:none;" data-top-top='position:fixed;top:0;left:0;box-shadow:0px 1px 1px rgba(0,0,0,0.2)'>
  <a href="/">
    <div class="logo" data-0="width:133px;height:133px;" data--200-top-top="width:50px;height:50px;" ><span></span></div>
  </a>
  <div class="intro">
    <h1>Micah Roberson</h1>
    <h2>Developer &amp; Entrepreneur</h2>
    <h4>San Francisco, California</h4>
    <span style='display:none'>By <a href='https://plus.google.com/106721416583632264667' rel='author'>Micah Roberson</a></span>
    <a class='social-media-link' href='https://twitter.com/micahroberson' target='_blank'><i class='icon-twitter'></i></a>
    <a class='social-media-link' href='https://www.github.com/micahroberson' target='_blank'><i class='icon-github'></i></a>
    <a class='social-media-link' href='/atom.xml' target='_blank'><i class='icon-feed'></i></a>
    <a class='social-media-link' href='mailto:micah.roberson@gmail.com' target='_blank'><i class='icon-mail'></i></a>
  </div>
</div>

</header>
  <nav role="navigation">
  

</nav>
  <footer class='fixed-footer'>
    <div class='social-links'>
    
<section>
	<form action="http://micahroberson.us7.list-manage.com/subscribe/post?u=604e31743665c33977d2efa00&amp;id=bf22667003" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" target="_blank">
    <span>Get Fresh Content</span>
		<input type="text" placeholder="Your Email Here" autocomplete="off" name="EMAIL" id="mce-EMAIL">
		<button type="submit" name="subscribe" id="mc-embedded-subscribe">Subscribe</button>
	</form>
</section>


    </div>
  </footer>
  <div id="main">
    <div id="content" class="fadein">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <p class="meta">
        








  


<time datetime="2013-10-04T09:40:00-07:00" pubdate data-updated="true">Oct 04</time>
        
      </p>
    
    
      <h4 class="entry-title">Upload Files Directly to S3 W/ Backbone on Heroku</h4>
    
  </header>


<div class="entry-content"><p><a href="http://aws.amazon.com/s3/">S3</a> has been the defacto standard for some time now when it comes to cloud storage, specifically for handling user uploads. PaaS providers often have limitations on storage and/or file uploads &ndash; most notably Heroku, which doesn&rsquo;t allow any file writes outside of the /tmp directory. Fortunately this is an easy enough problem to solve, with help from <a href="https://github.com/thoughtbot/paperclip">Paperclip</a> and <a href="https://github.com/carrierwaveuploader/carrierwave">CarrierWave</a>. Although utilizing one of these options may be easy and not all that different from how you would handle user uploads in a classic Rails app where you CAN write to the filesystem, they aren&rsquo;t all that efficient on Heroku. A simple file upload becomes a data-intesive, long-drawn-out request in order to get the file from the browser(client) to the server(Heroku) and then to S3. Ideally these gems would process the file(s) in the background, and we could say the time to do so is negligible as a result. But when we decide we want to show progress to the user and also know when the upload is complete, things get a lot more complicated!</p>

<p>This solution was originally built by Rok Krulec at <a href="http://dubjoy.com">Dubjoy</a>, and can be found here: <a href="http://codeartists.com/post/36892733572/how-to-directly-upload-files-to-amazon-s3-from-your">http://codeartists.com/post/36892733572/how-to-directly-upload-files-to-amazon-s3-from-your</a>, but I&rsquo;ve forked the code and made some tweaks to handle multiple files, progress, and cancellations.</p>

<p>In order to implement the entirety of this setup, you&rsquo;ll need a CORS enabled bucket. Follow <a href="http://codeartists.com/post/36892733572/how-to-directly-upload-files-to-amazon-s3-from-your">Step 1</a> for instructions. You&rsquo;ll also need to setup server-side request signing, which Rok Krulec shows how to do in <a href="http://codeartists.com/post/36892733572/how-to-directly-upload-files-to-amazon-s3-from-your">Step 3</a>.</p>

<p>For the client-side implementation, which is Step 2 from the blog post linked above, we&rsquo;ll do things a little differently.</p>

<p>You can find my forked repo with the necessary S3Upload lib here: <a href="https://github.com/micahroberson/s3upload-coffee-javascript">https://github.com/micahroberson/s3upload-coffee-javascript</a></p>

<p>To a Backbone view I&rsquo;ve added the following:</p>

<pre><code># Listener to detect when the user has selected a file.
# We could also opt for a click event on an 'Upload Files' button instead
events:
  'change input#Files': 'onChangeFiles'

...

# Listen for newly added models and render a view for each
initialize: () -&gt;
  @listenTo @attachmentsCollection, 'add', @onAddAttachment
...

# Instantiate and render new views for models added to the collection
# This is the view that will be listening to the 'upload:progress' event, and can also allow the user to cancel the upload
onAddAttachment: (model, response) -&gt;
  attachmentView = new Doozie.Views.Attachments.Show(model: model)
  @$('.card-attachments').append(attachmentView.render().el)
  @attachmentViews[model.cid] = attachmentView

...

# Callback bound above which triggers the actual upload via the S3Upload lib
onChangeFiles: (e) -&gt;
  return if $(e.target).val() == ''

  @uploadToS3
    files_dropped: false,
    file_dom_selector: '#Files'

...

# Instantiation of a new S3Upload with custom callbacks
uploadToS3: (options) -&gt;
  # We create an object to store the newly created models for reference in progress and abort callbacks
  newAttachments = {}
  s3upload = new S3Upload
    # files_dropped and file_list are only necessary for handling drag and drop uploads, which we'll address later
    files_dropped: options.files_dropped,
    file_list: options.file_list,
    file_dom_selector: options.file_dom_selector,
    s3_sign_put_url: '/api/attachments/signput',

    onProgress: (xhr, file, percent, message) =&gt;
      # Create a new Attachment model for the file which has just started uploading, otherwise trigger an 'upload:progress' event on the model which a view can listen for
      if percent == 0
        attachment = new Doozie.Models.Attachment
          name : file.name, 
          s3_url: '', 
          card_id : @model.id,
          project_id: @model.get('project_id'),
          file_type : file.type, 
          size : parseFloat(file.size)
        # Key on file.size for uniqueness
        newAttachments[file.size] = attachment
        # Add the model to the Backbone collection, which will trigger an 'add' event
        @attachmentsCollection.add(attachment)
      else
        attachment = newAttachments[file.size]
        if attachment
          attachment.trigger('upload:progress', { percent: percent, message: message, xhr: xhr })

    onAbort: (file, message) =&gt;
      attachment = newAttachments[file.size]
      attachment.destroy()
      delete newAttachments[file.size]
      # Must replace old input type=file. for some reason, it doesn't clear the value
      @$('input#Files').replaceWith("&lt;input id='files' type='file' name='files[]' multiple /&gt;")

    onFinishS3Put: (public_url, file) =&gt;
      # Grab the attachment model and update it with the final url
      # Also note that the model has not yet been saved, so the backend would be unaware of a cancelled upload
      attachment = newAttachments[file.size]
      attachment.save({ s3_url: public_url })

    onError: (file, status) =&gt;
      console.log('Upload error: ', status)
      attachment = newAttachments[file.size]
      attachment.destroy()
      delete newAttachments[file.size]
</code></pre>

<p>The attachment view(s) instantiated above looks like this:</p>

<pre><code>...

events: 
  'click .cancel' : 'onCancelUpload'

initialize: () -&gt;
  @listenTo(@model, 'upload:progress', @onUploadProgress)
  @listenTo(@model, 'destroy', @destroy)

onUploadProgress: (data) -&gt;
  @$('.progress .meter').css('width', "#{data.percent}%")

  if data.percent == 100
    # If the upload is complete, remove the progress bar and cancel button
    @$('.progress, .cancel').remove()
    @_xhr = null
  else if !@_xhr
    # Else if @_xhr is not yet defined, save a reference to it
    @_xhr = data.xhr

onCancelUpload: (e) -&gt;
  # Leverage the saved xhr reference to abort() the upload
  if @_xhr
    @_xhr.abort()
</code></pre>

<p>On the Rails side of things, we&rsquo;re really only storing the S3 url and a few other details about the file that we may want to display. The most important piece here is the after_destroy callback to actually delete the S3 object when the model is destroyed. Note that this uses the &lsquo;aws-sdk&rsquo; gem.</p>

<pre><code>class Attachment
  include Mongoid::Document
  include Mongoid::Timestamps

  field :name, type: String
  field :s3_url, type: String
  field :file_type, type: String
  field :size, type: Float

  belongs_to :creator, class_name: 'User', inverse_of: nil
  belongs_to :card, inverse_of: :blobs, touch: true

  after_destroy :delete_from_s3

  def delete_from_s3
    s3 = AWS::S3.new access_key_id: ENV['S3_ACCESS_KEY'], secret_access_key: ENV['S3_SECRET_KEY']
    key = s3_url.sub("https://s3.amazonaws.com/#{ENV['S3_BUCKET_NAME']}/", "")
    s3.buckets[ENV['S3_BUCKET_NAME']].objects[key].delete
  end

end
</code></pre>

<p>And that&rsquo;s all there is to it! We&rsquo;ve built a simple and efficient solution that allows users to upload multiple files at the same time, see indiviual progress bars for each file and also cancel each file independently. To take this a little further we can allow users to drag files onto the view and trigger an upload, and also create a proxy route for downloading files, which hides the actual S3 url.</p>

<p>To upload files on &lsquo;drop&rsquo;, just add the following event listener and handler, and it will trigger the same sequence of events as with the file type input.</p>

<pre><code>events: 
  'drop'  :  'onDrop'

onDrop: (e) -&gt;
  return if e.dataTransfer == null

  @uploadToS3({
    files_dropped: true,
    file_list: e.dataTransfer.files
  });
</code></pre>

<p>For the download link, we just use a controller action mapped to /attachments/download/:id</p>

<pre><code>def download
  @attachment = Attachment.where( company_id: current_user.company_id, id: params[:id] ).first
  data = open URI.parse(@attachment.s3_url)
  send_data data.read, filename: "#{@attachment.name}", type: "#{@attachment.file_type}", disposition: 'inline', stream: 'true', buffer_size: '4096'
end
</code></pre>
</div>

  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Micah Roberson</span></span>

      








  


<time datetime="2013-10-04T09:40:00-07:00" pubdate data-updated="true">Oct 04</time>
      


    </p>
    
      <div class="sharing">
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/saving-drag-and-drop-sort-position/" title="Previous Post: Saving Drag and Drop Sort Position">&laquo; Saving Drag and Drop Sort Position</a>
      
      
    </p>
  </footer>
</article>

</div>


    </div>
  </div>
</body>
</html>
